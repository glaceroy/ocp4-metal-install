---
- name: Create htpasswd user in OpenShift
  hosts: localhost
  gather_facts: false
  vars:
    # User credentials
    username: "admin"
    password: "aiyaz"
    # File path for htpasswd
    htpasswd_file: "/root/htpasswd"
    # Secret name and namespace
    secret_name: "htpasswd-secret"
    namespace: "openshift-config"
    # OAuth identity provider name
    idp_name: "htpasswd_provider"

  tasks:
    # --------------------------------------------------
    # Create or update htpasswd file
    # --------------------------------------------------
    - name: Create or update htpasswd file
      community.general.htpasswd:
        path: "{{ htpasswd_file }}"
        name: "{{ username }}"
        password: "{{ password }}"
        create: yes

    # --------------------------------------------------
    # Create secret with htpasswd file
    # --------------------------------------------------
    - name: Create secret with htpasswd file
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ secret_name }}"
            namespace: "{{ namespace }}"
          type: Opaque
          data:
            htpasswd: "{{ lookup('file', htpasswd_file) | b64encode }}"

    # --------------------------------------------------
    # Update OAuth configuration
    # --------------------------------------------------
    - name: Update OAuth configuration to use htpasswd identity provider
      k8s:
        state: patched
        definition:
          apiVersion: config.openshift.io/v1
          kind: OAuth
          metadata:
            name: cluster
          spec:
            identityProviders:
              - name: "{{ idp_name }}"
                mappingMethod: claim
                type: HTPasswd
                htpasswd:
                  fileData:
                    name: "{{ secret_name }}"

    # --------------------------------------------------
    # Grant cluster-admin to htpasswd user using oc command
    # --------------------------------------------------
    - name: Grant cluster-admin role to user
      command: oc adm policy add-cluster-role-to-user cluster-admin {{ username }}
      register: cluster_role_result
      changed_when: cluster_role_result.rc == 0
      failed_when: cluster_role_result.rc != 0 and 'already exists' not in cluster_role_result.stderr