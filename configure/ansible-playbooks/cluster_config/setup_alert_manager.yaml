---
- name: Configure OpenShift AlertManager for Slack Notifications
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    oc_kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('/etc/kubernetes/admin.conf') }}"
    slack_webhook_url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
    slack_channel: "#ocp-alerts"
    slack_username: "OpenShift AlertManager"

  tasks:
    - name: Create Slack receiver config
      set_fact:
        alertmanager_config: |
          global:
            slack_api_url: '{{ slack_webhook_url }}'

          route:
            group_by: ['alertname', 'cluster', 'namespace']
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h
            receiver: slack

          receivers:
          - name: slack
            slack_configs:
            - api_url: '{{ slack_webhook_url }}'
              channel: '{{ slack_channel }}'
              username: '{{ slack_username }}'
              send_resolved: true
              icon_emoji: ":rotating_light:"
              title: '{{ template "slack.title" . }}'
              text: '{{ template "slack.text" . }}'
              color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

    - name: Create AlertManagerConfig CR for Slack
      k8s:
        state: present
        definition:
          apiVersion: monitoring.coreos.com/v1alpha1
          kind: AlertmanagerConfig
          metadata:
            name: slack-notifications
            namespace: openshift-monitoring
            labels:
              alertmanagerconfig: slack-config
          spec:
            routeSelector:
              matchLabels:
                name: slack-receiver
            receivers:
            - name: slack
              slackConfigs:
              - apiURLSecret:
                  name: slack-webhook-secret
                  key: webhook-url
                channel: "{{ slack_channel }}"
                sendResolved: true
                text: "{{ range .Alerts }}*Alert:* {{ .Annotations.summary }}{{ range $key, $value := .Annotations }}{{ if ne $key \"summary\" }}\n{{ $key }}: {{ $value }}{{ end }}{{ end }}{{ end }}"
        kubeconfig: "{{ oc_kubeconfig }}"

    - name: Create Slack webhook secret
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: slack-webhook-secret
            namespace: openshift-monitoring
          type: Opaque
          stringData:
            webhook-url: "{{ slack_webhook_url }}"
        kubeconfig: "{{ oc_kubeconfig }}"

    - name: Patch main AlertManager to use Slack config
      k8s_exec:
        namespace: openshift-monitoring
        kubeconfig: "{{ oc_kubeconfig }}"
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: alertmanager-main
      register: alertmanager_patch

    - name: Verify AlertManagerConfig applied
      k8s_info:
        kind: AlertmanagerConfig
        name: slack-notifications
        namespace: openshift-monitoring
      register: slack_config
      until: slack_config.resources | length > 0
      retries: 10
      delay: 10
      kubeconfig: "{{ oc_kubeconfig }}"

    - name: Restart AlertManager pods to pick up config
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: alertmanager-main
            namespace: openshift-monitoring
        kubeconfig: "{{ oc_kubeconfig }}"
      register: restart_result

    - name: Wait for AlertManager pods to restart
      k8s_info:
        kind: Pod
        namespace: openshift-monitoring
        label_selectors:
          - app.kubernetes.io/name=alertmanager
      register: pods
      until: >
        pods.resources | 
        selectattr('status.phase', 'equalto', 'Running') | 
        list | length == 3
      retries: 20
      delay: 15
      kubeconfig: "{{ oc_kubeconfig }}"

    - name: Test Slack notifications with Watchdog alert
      debug:
        msg:
          - "AlertManager configured for Slack!"
          - "Check {{ slack_channel }} for alerts"
          - "Test with: oc -n openshift-monitoring get alertmanagerconfig"
          - "Watchdog alert should appear in Slack within 2 minutes"
