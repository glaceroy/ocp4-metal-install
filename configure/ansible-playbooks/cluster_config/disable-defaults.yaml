---
- name: Disable Insights Operator and default OperatorHub sources for disconnected environment
  hosts: localhost
  gather_facts: false

  vars:
    kubeconfig: /root/.kube/config

  tasks:
    # --------------------------------------------------
    # Extract pull-secret to local directory
    # --------------------------------------------------
    - name: Create temporary working directory
      tempfile:
        state: directory
        suffix: pull-secret
      register: temp_dir

    - name: Extract pull-secret to local directory
      shell: |
        oc extract secret/pull-secret -n openshift-config --to={{ temp_dir.path }}
      args:
        creates: "{{ temp_dir.path }}/.dockerconfigjson"

    # --------------------------------------------------
    # Read and modify .dockerconfigjson
    # --------------------------------------------------
    - name: Read .dockerconfigjson content
      slurp:
        src: "{{ temp_dir.path }}/.dockerconfigjson"
      register: docker_config

    - name: Decode docker config JSON
      set_fact:
        docker_config_json: "{{ (docker_config.content | b64decode | from_json).auths }}"

    # --------------------------------------------------
    # Remove cloud.openshift.com using dict filter (compatible with Ansible 2.15)
    # --------------------------------------------------
    - name: Remove cloud.openshift.com from auths
      set_fact:
        cleaned_auths: "{{ docker_config_json | dict2items | rejectattr('key', 'match', 'cloud.openshift.com') | items2dict }}"

    - name: Rebuild complete docker config
      set_fact:
        cleaned_config: >-
          {{
            {
              'auths': cleaned_auths
            }
          }}

    # --------------------------------------------------
    # Update the pull-secret in cluster
    # --------------------------------------------------
    - name: Update global pull-secret in cluster
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: pull-secret
            namespace: openshift-config
          type: kubernetes.io/dockerconfigjson
          data:
            .dockerconfigjson: "{{ (cleaned_config | to_json) | b64encode }}"

    # --------------------------------------------------
    # Cleanup
    # --------------------------------------------------
    - name: Cleanup temporary files
      file:
        path: "{{ temp_dir.path }}"
        state: absent

    # --------------------------------------------------
    # Disable default OperatorHub sources (optional)
    # --------------------------------------------------
    - name: Disable default OperatorHub sources
      command: >
        oc patch operatorhub cluster
        --type=merge
        -p '{"spec":{"disableAllDefaultSources": true}}'
      register: operatorhub_result
      changed_when: "'patched' in operatorhub_result.stdout or operatorhub_result.rc == 0"

    # --------------------------------------------------
    # Set cluster upgrade channel to empty
    # --------------------------------------------------
    - name: Set ClusterVersion channel to empty
      command: >
        oc patch clusterversion version
        --type=merge
        -p '{"spec":{"channel":""}}'
      register: channel_patch
      changed_when: "'patched' in channel_patch.stdout or channel_patch.rc == 0"

    # --------------------------------------------------
    # Verification
    # --------------------------------------------------
    - name: Verify cluster upgrade channel
      command: >
        oc get clusterversion version
        -o jsonpath='{.spec.channel}{"\n"}'
      register: channel_state

    - debug:
        msg: "Cluster upgrade channel is set to: '{{ channel_state.stdout }}'"