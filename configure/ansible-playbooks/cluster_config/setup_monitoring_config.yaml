---
- name: Configure OpenShift Monitoring and User Workload Monitoring (Disconnected)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    monitoring_namespace: "openshift-monitoring"
    user_monitoring_namespace: "openshift-user-workload-monitoring"

    # Storage configuration
    monitoring_storage_class: "nfs-csi-storageclass"
    monitoring_storage_size: "2Gi"
    monitoring_retention: "2d"

  tasks:

  ###########################################################################
  # Namespaces
  ###########################################################################

  - name: Ensure openshift-monitoring namespace exists
    k8s:
      api_version: v1
      kind: Namespace
      name: "{{ monitoring_namespace }}"
      state: present

  - name: Ensure openshift-user-workload-monitoring namespace exists
    k8s:
      api_version: v1
      kind: Namespace
      name: "{{ user_monitoring_namespace }}"
      state: present

  ###########################################################################
  # Enable User Workload Monitoring
  ###########################################################################

  - name: Enable user workload monitoring
    k8s:
      state: present
      definition:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: user-workload-monitoring-config
          namespace: "{{ user_monitoring_namespace }}"
        data:
          config.yaml: |
            prometheus: 
              retention: "{{ monitoring_retention }}"
              volumeClaimTemplate:
                spec:
                  storageClassName: "{{ monitoring_storage_class }}"
                  resources:
                    requests:
                      storage: "{{ monitoring_storage_size }}"

  ###########################################################################
  # Configure Cluster Monitoring (Persistent Storage, Retention)
  ###########################################################################

  - name: Configure cluster monitoring storage and retention
    k8s:
      state: present
      definition:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: cluster-monitoring-config
          namespace: "{{ monitoring_namespace }}"
        data:
          config.yaml: |
            enableUserWorkload: true
            prometheusK8s:
              retention: "{{ monitoring_retention }}"
              volumeClaimTemplate:
                spec:
                  storageClassName: "{{ monitoring_storage_class }}"
                  resources:
                    requests:
                      storage: "{{ monitoring_storage_size }}"
            alertmanagerMain:
              volumeClaimTemplate:
                spec:
                  storageClassName: "{{ monitoring_storage_class }}"
                  resources:
                    requests:
                      storage: "{{ monitoring_storage_size }}"

  ###########################################################################
  # Wait for Monitoring Pods
  ###########################################################################

  - name: Wait for Prometheus pods to be running
    shell: |
      oc wait --for=condition=Ready pod \
        -l app.kubernetes.io/name=prometheus \
        -n {{ monitoring_namespace }} \
        --timeout=300s
    register: prometheus_wait
    changed_when: false

  - name: Wait for Alertmanager pods to be running
    shell: |
      oc wait --for=condition=Ready pod \
        -l app.kubernetes.io/name=alertmanager \
        -n {{ monitoring_namespace }} \
        --timeout=300s
    register: alertmanager_wait
    changed_when: false

  - name: Wait for User Workload Prometheus StatefulSet
    shell: |
      oc rollout status statefulset/prometheus-user-workload \
        -n openshift-user-workload-monitoring \
        --timeout=300s
    changed_when: false


  ###########################################################################
  # Verification
  ###########################################################################

  - name: Get monitoring pods
    shell: oc get pods -n {{ monitoring_namespace }}
    register: monitoring_pods
    changed_when: false

  - name: Get user workload monitoring pods
    shell: oc get pods -n {{ user_monitoring_namespace }}
    register: user_monitoring_pods
    changed_when: false

  - name: Display cluster monitoring pods (readable)
    debug:
      msg: "{{ item }}"
    loop: "{{ monitoring_pods.stdout_lines }}"

  - name: Display user workload monitoring pods (readable)
    debug:
      msg: "{{ item }}"
    loop: "{{ user_monitoring_pods.stdout_lines }}"


