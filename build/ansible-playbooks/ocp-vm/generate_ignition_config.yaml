---
- name: Generate OpenShift manifests and ignition configs
  hosts: localhost
  gather_facts: false

  vars:
    install_config_path: "/root/ocp4-metal-install/build/install-config/install-config.yaml"
    output_dir: "/root/ocp-install-config"
    web_dir: "/var/www/html/ocp4"
    scheduler_manifest: "{{ output_dir }}/manifests/cluster-scheduler-02-config.yml"

  tasks:

    # --------------------------------------------------
    # Clean and prepare output directory
    # --------------------------------------------------
    - name: Recreate clean output directory
      file:
        path: "{{ output_dir }}"
        state: "{{ item }}"
        mode: '0755'
      loop:
        - absent
        - directory

    - name: Copy install-config.yaml to output directory
      copy:
        src: "{{ install_config_path }}"
        dest: "{{ output_dir }}/install-config.yaml"
        mode: '0644'

    # --------------------------------------------------
    # Create manifests
    # --------------------------------------------------
    - name: Create manifests
      command: "openshift-install create manifests --dir {{ output_dir }}"
      environment:
        HOME: "{{ ansible_env.HOME }}"
      register: manifest_result
      failed_when: manifest_result.rc != 0
      changed_when: "'Creating' in manifest_result.stdout"

    # --------------------------------------------------
    # Disable scheduling on master nodes
    # --------------------------------------------------
    - name: Disable scheduling on master nodes
      lineinfile:
        path: "{{ scheduler_manifest }}"
        regexp: '^(\s*)mastersSchedulable:'
        line: '\1mastersSchedulable: false'
        backrefs: yes
      when: scheduler_manifest is defined and scheduler_manifest is file

    # --------------------------------------------------
    # Show only spec.mastersSchedulable value
    # --------------------------------------------------
    - name: Show only spec.mastersSchedulable value
      command: "grep -o 'mastersSchedulable:.*' {{ scheduler_manifest }}"
      register: masters_schedulable_value
      changed_when: false
    - debug:
        msg: "{{ masters_schedulable_value.stdout }}"

    # --------------------------------------------------
    # Create ignition-configs
    # --------------------------------------------------
    - name: Create ignition-configs
      command: "openshift-install create ignition-configs --dir {{ output_dir }}"
      environment:
        HOME: "{{ ansible_env.HOME }}"
      register: ignition_result
      failed_when: ignition_result.rc != 0
      changed_when: "'Creating' in ignition_result.stdout"

    # --------------------------------------------------
    # Clean and prepare web directory
    # --------------------------------------------------
    - name: Recreate clean web directory
      file:
        path: "{{ web_dir }}"
        state: "{{ item }}"
        mode: '0755'
      loop:
        - absent
        - directory

    # --------------------------------------------------
    # Copy ignition files
    # --------------------------------------------------
    - name: Find ignition files
      find:
        paths: "{{ output_dir }}"
        patterns: "*.ign"
      register: ignition_files

    - name: Publish ignition files to web directory
      copy:
        src: "{{ item.path }}"
        dest: "{{ web_dir }}/{{ item.path | basename }}"
        owner: apache
        group: apache
        mode: '0644'
      loop: "{{ ignition_files.files }}"

    # --------------------------------------------------
    # Permissions and SELinux
    # --------------------------------------------------
    - name: Set SELinux context and permissions for Apache
      block:
        - command: chcon -R -t httpd_sys_content_t "{{ web_dir }}"
        - file:
            path: "{{ web_dir }}"
            owner: apache
            group: apache
            mode: '0755'
            recurse: yes

    # --------------------------------------------------
    # Verification
    # --------------------------------------------------
    - name: List ignition files in web directory
      command: ls -l "{{ web_dir }}"
      register: file_list

    - debug:
        msg: "{{ file_list.stdout_lines }}"
