# install-cluster.yaml
---
- name: Deploy OpenShift CoreOS VMs on Proxmox
  hosts: proxmox
  gather_facts: false
  collections:
    - community.proxmox       # use the proxmox collection
  vars_files:
    - vars.yaml

  tasks:

    # --------------------------------------------------
    # Ensure RHCOS ISO exists
    # --------------------------------------------------
#    - name: Check if RHCOS ISO exists
#      ansible.builtin.stat:
#        path: "{{ rhcos_iso }}"
#      register: iso_check

#    - name: Upload RHCOS ISO if missing
#      ansible.builtin.copy:
#        src: "{{ rhcos_iso | basename }}"
#        dest: "{{ rhcos_iso }}"
#        mode: "0644"
#      when: not iso_check.stat.exists

    # --------------------------------------------------
    # Create Bootstrap VM from ISO
    # --------------------------------------------------
    - name: Create bootstrap VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults.bootstrap.memory }}"
        cores: "{{ defaults.bootstrap.cores }}"
        cpu: "{{ defaults.bootstrap.cpu }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: "order=scsi0;ide2;net0"
        bootdisk: scsi0
        scsihw: "{{ defaults.bootstrap.scsihw }}"
        scsi:
          scsi0: "{{ storage }}:{{ defaults.bootstrap.disk }},iothread=1"
        ostype: l26
        state: present
      loop: "{{ bootstrap }}"

    - name: Start bootstrap VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ bootstrap }}"

    # --------------------------------------------------
    # Create Installer VMs for templates
    # --------------------------------------------------
    - name: Create installer template VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults[item.role].memory }}"
        cores: "{{ defaults[item.role].cores }}"
        cpu: "{{ defaults[item.role].cpu }}"
        net:
          net0: "virtio,bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: "order=scsi0;ide2;net0"
        bootdisk: scsi0
        scsihw: "{{ defaults[item.role].scsihw }}"
        scsi:
          scsi0: "{{ storage }}:{{ item.disk }},iothread=1"
        ostype: l26
        state: present
      loop: "{{ templates }}"

    - name: Start installer template VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ templates }}"

    - name: Boot installer VMs from disk
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        boot: scsi0
        state: present
      loop: "{{ templates }}"

    - name: Wait 2 minutes before stopping installer VMs
      ansible.builtin.pause:
        minutes: 2

    - name: Stop installer VMs before converting
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: stopped
      loop: "{{ templates }}"

    - name: Wait until template installer VMs are fully stopped
      shell: qm status {{ item.vmid }} | awk '{print $3}'
      register: template_stop
      retries: 30
      delay: 10
      until: template_stop.stdout.strip() == "stopped"
      delegate_to: "{{ ansible_host }}"
      become: true
      loop: "{{ templates }}"

    - name: Convert installer VMs to templates
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        template: true
      loop: "{{ templates }}"

    # --------------------------------------------------
    # Clone Master and Worker VMs from templates
    # --------------------------------------------------
    - name: Clone Master VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        clone: "{{ master_template_vmid }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        full: true
        state: present
      loop: "{{ masters }}"

    - name: Clone Worker VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        clone: "{{ worker_template_vmid }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        full: true
        state: present
      loop: "{{ workers }}"

    - name: Start all Master VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ masters }}"

    - name: Enable Proxmox firewall on all VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        firewall: yes
      loop: "{{ bootstrap + masters + workers }}"
