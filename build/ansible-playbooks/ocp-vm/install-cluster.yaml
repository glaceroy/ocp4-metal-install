# install-cluster.yaml
---
- name: Deploy OpenShift CoreOS VMs on Proxmox
  hosts: proxmox
  gather_facts: false
  collections:
    - community.proxmox       # use the proxmox collection
  vars_files:
    - vars.yaml

  tasks:

    # --------------------------------------------------
    # Ensure RHCOS ISO exists
    # --------------------------------------------------
#    - name: Check if RHCOS ISO exists
#      ansible.builtin.stat:
#        path: "{{ rhcos_iso }}"
#      register: iso_check

#    - name: Upload RHCOS ISO if missing
#      ansible.builtin.copy:
#        src: "{{ rhcos_iso | basename }}"
#        dest: "{{ rhcos_iso }}"
#        mode: "0644"
#      when: not iso_check.stat.exists

    # --------------------------------------------------
    # Create Bootstrap VM from ISO
    # --------------------------------------------------
    - name: Create bootstrap VM
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults.bootstrap.memory }}"
        cores: "{{ defaults.bootstrap.cores }}"
        cpu: "{{ defaults.bootstrap.cpu }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: cd
        scsihw: "{{ defaults.bootstrap.scsihw }}"
        scsi:
          scsi0: "{{ storage }}:40"
        ostype: l26
        state: present
      loop: "{{ bootstrap }}"

    - name: Inject bootstrap installer args
      command: >
        qm set {{ item.vmid }}
        --args "-append coreos.inst.install_dev=/dev/sda
        coreos.inst.ignition_url={{ defaults.bootstrap.ignition }}
        coreos.inst.insecure"
      delegate_to: "{{ ansible_host }}"
      become: true
      loop: "{{ bootstrap }}"

    - name: Start bootstrap VM
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ bootstrap }}"

    # --------------------------------------------------
    # Create Installer VMs for OSE nodes templates
    # --------------------------------------------------
    - name: Create installer VMs for templates
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults[item.role].memory }}"
        cores: "{{ defaults[item.role].cores }}"
        cpu: "{{ defaults[item.role].cpu }}"
        net:
          net0: "virtio,bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: cd
        scsihw: "{{ defaults[item.role].scsihw }}"
        scsi:
          scsi0: "{{ storage }}:{{ item.disk }}"
        ostype: l26
        state: present
      loop: "{{ templates }}"

    - name: Inject installer args for templates
      command: >
        qm set {{ item.vmid }}
        --args "-append coreos.inst.install_dev=/dev/sda
        coreos.inst.ignition_url={{ defaults[item.role].ignition }}
        coreos.inst.insecure"
      delegate_to: "{{ ansible_host }}"
      become: true
      loop: "{{ templates }}"

    - name: Start template installer VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ templates }}"

    - name: Wait for install reboot
      shell: qm status {{ item.vmid }} | awk '{print $3}'
      register: reboot_check
      retries: 30
      delay: 15
      until: reboot_check.stdout | int < 120
      loop: "{{ templates }}"

    - name: Clear installer args
      command: qm set {{ item.vmid }} --args ""
      delegate_to: "{{ ansible_host }}"
      become: true
      loop: "{{ templates }}"

    - name: Boot from disk
      command: qm set {{ item.vmid }} --boot order=scsi0
      delegate_to: "{{ ansible_host }}"
      become: true
      loop: "{{ templates }}"

    - name: Convert to templates
      command: qm template {{ item.vmid }}
      loop: "{{ templates }}"

    # --------------------------------------------------
    # Clone Master and Worker VMs from template
    # --------------------------------------------------
    - name: Clone masters
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        clone: 9001
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        full: true
        state: present
      loop: "{{ masters }}"

    - name: Clone workers
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        clone: 9002
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        full: true
        state: present
      loop: "{{ workers }}"
