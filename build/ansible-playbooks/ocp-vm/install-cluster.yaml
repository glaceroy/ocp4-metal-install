---
# install-cluster.yaml
- name: Deploy OpenShift CoreOS VMs on Proxmox from ISO
  hosts: proxmox
  gather_facts: false
  collections:
    - community.proxmox
  vars_files:
    - vars.yaml

  tasks:
    # --------------------------------------------------
    # Gather existing Proxmox VMs (idempotency)
    # --------------------------------------------------
    - name: Gather existing Proxmox VMs
      community.proxmox.proxmox_vm_info:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
      register: proxmox_vms

    - name: Build list of existing VMIDs
      set_fact:
        existing_vmids: "{{ proxmox_vms.vms | default([]) | map(attribute='vmid') | list }}"

    # --------------------------------------------------
    # Combine all nodes into a single loop
    # --------------------------------------------------
    - name: Combine all nodes (bootstrap + masters + workers)
      set_fact:
        all_nodes: >-
          {{
            (bootstrap | map('combine', {'role': 'bootstrap'}) | list)
            + (masters | map('combine', {'role': 'master'}) | list)
            + (workers | map('combine', {'role': 'worker'}) | list)
          }}

    # --------------------------------------------------
    # Create all VMs from ISO
    # --------------------------------------------------
    - name: Create and start all VMs from ISO
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: >-
          {{ defaults[item.role].memory if item.role != 'bootstrap' else defaults.bootstrap.memory }}
        cores: >-
          {{ defaults[item.role].cores if item.role != 'bootstrap' else defaults.bootstrap.cores }}
        cpu: >-
          {{ defaults[item.role].cpu if item.role != 'bootstrap' else defaults.bootstrap.cpu }}
        scsihw: >-
          {{ defaults[item.role].scsihw if item.role != 'bootstrap' else defaults.bootstrap.scsihw }}
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }},firewall=1"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: "order=scsi0;ide2;net0"
        bootdisk: scsi0
        scsi:
          scsi0: "{{ storage }}:{{ defaults[item.role].disk | default(40) }},iothread=1"
        ostype: l26
        state: present
      loop: "{{ all_nodes }}"
      when: item.vmid not in existing_vmids

    # --------------------------------------------------
    # Start all VMs
    # --------------------------------------------------
    - name: Ensure all VMs are started
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ all_nodes }}"


