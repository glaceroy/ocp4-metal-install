- name: Deploy OpenShift CoreOS VMs on Proxmox
  hosts: proxmox
  gather_facts: false
  collections:
    - community.general
  vars_files:
    - vars.yaml

  tasks:

    # --------------------------------------------------
    # Ensure RHCOS ISO exists
    # --------------------------------------------------
    - name: Check if RHCOS ISO exists
      stat:
        path: "{{ rhcos_iso }}"
      register: iso_check

    - name: Upload RHCOS ISO if missing
      copy:
        src: "{{ rhcos_iso | basename }}"
        dest: "{{ rhcos_iso }}"
        mode: '0644'
      when: not iso_check.stat.exists

    # --------------------------------------------------
    # Create Bootstrap VM from ISO
    # --------------------------------------------------
    - name: Create bootstrap VM from ISO
      community.general.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults.bootstrap.memory }}"
        cores: "{{ defaults.bootstrap.cores }}"
        net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        ide2: "{{ rhcos_iso }},media=cdrom"
        boot: cd
        scsihw: virtio-scsi-pci
        scsi0: "{{ storage }}:{{ template.disk }}"
        ostype: l26
        state: present
      loop: "{{ bootstrap }}"
      loop_control:
        loop_var: item

    - name: Start bootstrap VM
      community.general.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ bootstrap }}"
      loop_control:
        loop_var: item

    - name: Install CoreOS on bootstrap VM via Ignition
      ansible.builtin.shell: |
        ssh -o StrictHostKeyChecking=no core@{{ item.ip }} \
        "sudo coreos-installer install /dev/sda --ignition-url {{ defaults.bootstrap.ignition }} --insecure-ignition"
      loop: "{{ bootstrap }}"
      loop_control:
        loop_var: item

    - name: Convert bootstrap VM to template
      command: qm template {{ template.vmid }}

    # --------------------------------------------------
    # Clone and start Masters
    # --------------------------------------------------
    - name: Clone master nodes from template
      loop: "{{ masters }}"
      loop_control:
        loop_var: node
      block:
        - name: Clone {{ node.name }} from template
          community.general.proxmox_kvm:
            api_host: "{{ ansible_host }}"
            api_user: "{{ api_user }}"
            api_token_id: "{{ api_token_id }}"
            api_token_secret: "{{ api_token_secret }}"
            node: "{{ proxmox_node }}"
            vmid: "{{ node.vmid }}"
            clone: "{{ template.vmid }}"
            name: "{{ node.name }}"
            full: true
            memory: "{{ defaults.master.memory }}"
            cores: "{{ defaults.master.cores }}"
            net0: "virtio={{ node.mac }},bridge={{ bridge }}"
            state: present

        - name: Start master VM {{ node.name }}
          community.general.proxmox_kvm:
            api_host: "{{ ansible_host }}"
            api_user: "{{ api_user }}"
            api_token_id: "{{ api_token_id }}"
            api_token_secret: "{{ api_token_secret }}"
            node: "{{ proxmox_node }}"
            vmid: "{{ node.vmid }}"
            state: started

    # --------------------------------------------------
    # Clone and start Workers
    # --------------------------------------------------
    - name: Clone worker nodes from template
      loop: "{{ workers }}"
      loop_control:
        loop_var: node
      block:
        - name: Clone {{ node.name }} from template
          community.general.proxmox_kvm:
            api_host: "{{ ansible_host }}"
            api_user: "{{ api_user }}"
            api_token_id: "{{ api_token_id }}"
            api_token_secret: "{{ api_token_secret }}"
            node: "{{ proxmox_node }}"
            vmid: "{{ node.vmid }}"
            clone: "{{ template.vmid }}"
            name: "{{ node.name }}"
            full: true
            memory: "{{ defaults.worker.memory }}"
            cores: "{{ defaults.worker.cores }}"
            net0: "virtio={{ node.mac }},bridge={{ bridge }}"
            state: present

        - name: Start worker VM {{ node.name }}
          community.general.proxmox_kvm:
            api_host: "{{ ansible_host }}"
            api_user: "{{ api_user }}"
            api_token_id: "{{ api_token_id }}"
            api_token_secret: "{{ api_token_secret }}"
            node: "{{ proxmox_node }}"
            vmid: "{{ node.vmid }}"
            state: started
