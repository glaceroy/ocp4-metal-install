# install-cluster.yaml
---
- name: Deploy OpenShift CoreOS VMs on Proxmox
  hosts: proxmox
  gather_facts: false
  collections:
    - community.proxmox       # use the proxmox collection
  vars_files:
    - vars.yaml

  tasks:

    # --------------------------------------------------
    # Ensure RHCOS ISO exists
    # --------------------------------------------------
#    - name: Check if RHCOS ISO exists
#      ansible.builtin.stat:
#        path: "{{ rhcos_iso }}"
#      register: iso_check

#    - name: Upload RHCOS ISO if missing
#      ansible.builtin.copy:
#        src: "{{ rhcos_iso | basename }}"
#        dest: "{{ rhcos_iso }}"
#        mode: "0644"
#      when: not iso_check.stat.exists

    # --------------------------------------------------
    # Create Bootstrap VM from ISO
    # --------------------------------------------------
    - name: Create bootstrap VM from ISO
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        memory: "{{ defaults.bootstrap.memory }}"
        cores: "{{ defaults.bootstrap.cores }}"
        cpu: "{{ defaults.bootstrap.cpu }}"  
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: cd
        scsihw: "{{ defaults.bootstrap.scsihw }}"
        scsi:
          scsi0: "{{ storage }}:{{ template.disk }}"
        ostype: l26
        firewall: "{{ defaults.bootstrap.firewall }}" 
        args: >
          -append "coreos.inst.install_dev=/dev/sda coreos.inst.ignition_url={{ defaults.bootstrap.ignition }} coreos.inst.insecure_ignition"
        state: present
      loop: "{{ bootstrap }}"
      loop_control:
        loop_var: item

    - name: Start bootstrap VM
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ bootstrap }}"
      loop_control:
        loop_var: item

    - name: Convert bootstrap VM to template
      ansible.builtin.command: qm template {{ template.vmid }}

    # --------------------------------------------------
    # Clone and start Masters
    # --------------------------------------------------
    - name: Clone master nodes from template
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ node.vmid }}"
        clone: "{{ template.vmid }}"
        name: "{{ node.name }}"
        full: true
        memory: "{{ defaults.master.memory }}"
        cores: "{{ defaults.master.cores }}"
        net:
          net0: "virtio={{ node.mac }},bridge={{ bridge }}"
        state: present
      loop: "{{ masters }}"
      loop_control:
        loop_var: node

    - name: Start master VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ node.vmid }}"
        state: started
      loop: "{{ masters }}"
      loop_control:
        loop_var: node

    # --------------------------------------------------
    # Clone and start Workers
    # --------------------------------------------------
    - name: Clone worker nodes from template
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ node.vmid }}"
        clone: "{{ template.vmid }}"
        name: "{{ node.name }}"
        full: true
        memory: "{{ defaults.worker.memory }}"
        cores: "{{ defaults.worker.cores }}"
        net:
          net0: "virtio={{ node.mac }},bridge={{ bridge }}"
        state: present
      loop: "{{ workers }}"
      loop_control:
        loop_var: node

    - name: Start worker VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ node.vmid }}"
        state: started
      loop: "{{ workers }}"
      loop_control:
        loop_var: node
