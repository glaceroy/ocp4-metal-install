---
# install-cluster.yaml
- name: Deploy OpenShift CoreOS VMs on Proxmox
  hosts: proxmox
  gather_facts: false
  collections:
    - community.proxmox

  vars_files:
    - vars.yaml

  tasks:
    # --------------------------------------------------
    # Gather existing Proxmox VMs (idempotency backbone)
    # --------------------------------------------------
    - name: Gather existing Proxmox VMs
      community.proxmox.proxmox_vm_info:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
      register: proxmox_vms

    - name: Build list of existing VMIDs
      ansible.builtin.set_fact:
        existing_vmids: "{{ proxmox_vms.vms | default([]) | map(attribute='vmid') | list }}"

    # --------------------------------------------------
    # Build template lookup (master / worker)
    # --------------------------------------------------
    - name: Build template map
      ansible.builtin.set_fact:
        template_map: >-
          {{
            dict(
              templates | map(attribute='role')
              | zip(templates | map(attribute='vmid'))
            )
          }}

    # --------------------------------------------------
    # Combine Masters and Workers into one loop
    # --------------------------------------------------
    - name: Combine master and worker node definitions
      ansible.builtin.set_fact:
        cluster_nodes: "{{ masters | map('combine', {'role': 'master'}) | list + workers | map('combine', {'role': 'worker'}) | list }}"

    # --------------------------------------------------
    # Create Cluster VMs (masters + workers)
    # --------------------------------------------------
    - name: Clone and configure cluster VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        clone: "{{ template_map[item.role] }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        full: true
        memory: "{{ defaults[item.role].memory }}"
        cores: "{{ defaults[item.role].cores }}"
        cpu: "{{ defaults[item.role].cpu }}"
        scsihw: "{{ defaults[item.role].scsihw }}"
        net:
          net0: "virtio={{ item.mac }},bridge={{ bridge }}"
        ide:
          ide2: "{{ rhcos_iso }},media=cdrom"
        boot: "order=scsi0;ide2;net0"
        bootdisk: scsi0
        scsi:
          scsi0: "{{ storage }}:{{ defaults[item.role].disk | default(40) }},iothread=1"
        ostype: l26
        state: present
      loop: "{{ cluster_nodes }}"
      when: item.vmid not in existing_vmids

    # --------------------------------------------------
    # Start Cluster VMs
    # --------------------------------------------------
    - name: Start all cluster VMs (masters + workers)
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ cluster_nodes }}"

    # --------------------------------------------------
    # Enable firewall everywhere (bootstrap + cluster)
    # --------------------------------------------------
    - name: Enable Proxmox firewall on all VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ ansible_host }}"
        api_user: "{{ api_user }}"
        api_token_id: "{{ api_token_id }}"
        api_token_secret: "{{ api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        firewall: yes
      loop: "{{ bootstrap + cluster_nodes }}"
