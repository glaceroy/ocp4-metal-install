---
- name: Clone {{ role_name }} VMs
  loop: "{{ range(0, role.count) | list }}"
  loop_control:
    loop_var: idx
  vars:
    vmid: "{{ role.vmid_base + idx }}"
    name: "{{ role_name }}-{{ idx + 1 }}"
  block:

  - name: Clone VM
    command: >
      qm clone {{ template.vmid }} {{ vmid }}
      --name {{ name }}
      --full true

  - name: Configure VM resources
    command: >
      qm set {{ vmid }}
      --memory {{ role.memory }}
      --cores {{ role.cores }}

  - name: Resize disk
    command: qm resize {{ vmid }} scsi0 {{ role.disk }}G

  - name: Start VM
    command: qm start {{ vmid }}
