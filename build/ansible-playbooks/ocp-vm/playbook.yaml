---
- name: Build OpenShift template and clone VMs
  hosts: proxmox
  gather_facts: false
  vars_files:
    - vars.yml

  tasks:

  - name: Create template VM
    community.general.proxmox_kvm:
      api_host: "{{ ansible_host }}"
      api_user: "{{ api_user }}"
      api_token_id: "{{ api_token_id }}"
      api_token_secret: "{{ api_token_secret }}"
      node: "{{ proxmox_node }}"
      vmid: "{{ template.vmid }}"
      name: "{{ template.name }}"
      memory: "{{ template.memory }}"
      cores: "{{ template.cores }}"
      net:
        net0: virtio,bridge={{ bridge }}
      scsihw: virtio-scsi-pci
      ostype: l26
      boot: order=scsi0
      state: present

  - name: Import cloud image disk into template
    command: >
      qm importdisk {{ template.vmid }}
      {{ cloud_image_path }}
      {{ storage }}
    args:
      creates: "/dev/{{ storage }}/vm-{{ template.vmid }}-disk-0"

  - name: Attach disk and cloud-init to template
    command: >
      qm set {{ template.vmid }}
      --scsi0 {{ storage }}:vm-{{ template.vmid }}-disk-0
      --ide2 {{ storage }}:cloudinit
      --serial0 socket
      --vga serial0

  - name: Configure cloud-init defaults on template
    command: >
      qm set {{ template.vmid }}
      --ciuser core
      --sshkeys "{{ ssh_pubkey }}"
      --ipconfig0 ip=dhcp

  - name: Resize template disk
    command: qm resize {{ template.vmid }} scsi0 {{ template.disk }}G

  - name: Convert VM to template
    command: qm template {{ template.vmid }}

  # --------------------------------------------------
  # Clone Bootstrap
  # --------------------------------------------------
  - name: Clone bootstrap
    include_tasks: clone.yml
    vars:
      role: bootstrap
      role_name: bootstrap

  # --------------------------------------------------
  # Clone Masters
  # --------------------------------------------------
  - name: Clone masters
    include_tasks: clone.yml
    vars:
      role: master
      role_name: master

  # --------------------------------------------------
  # Clone Workers
  # --------------------------------------------------
  - name: Clone workers
    include_tasks: clone.yml
    vars:
      role: worker
      role_name: worker
