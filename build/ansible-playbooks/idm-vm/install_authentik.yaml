---
- name: Install Authentik via Docker Compose with HTTPS
  hosts: 127.0.0.1
  connection: local
  become: yes
  gather_facts: yes

  vars:
    authentik_admin_user: "akadmin"
    admin_password: "aiyaz123"
    authentik_root: "/opt/authentik"
    docker_compose_url: "https://docs.goauthentik.io/docker-compose.yml"
    env_file: "{{ authentik_root }}/.env"
    authentik_dir: "/root/ocp4-metal-install/configure/certs/idm/certs"
    tls_cert_src: "{{ authentik_dir }}/idm.crt"
    tls_key_src: "{{ authentik_dir }}/idm.key"
    tls_cert_dest: "{{ authentik_root }}/certs/fullchain.pem"
    tls_key_dest: "{{ authentik_root }}/certs/privkey.pem"
    pg_pass_length: 36
    secret_key_length: 60
    authentik_port: 9443
    authentik_host: "idm.cloud.lab"

  tasks:
    # --------------------------------------------------
    # Ensure directories
    # --------------------------------------------------
    - name: Create Authentik directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - "{{ authentik_root }}"
        - "{{ authentik_root }}/certs"
        - "{{ authentik_root }}/data"

    # --------------------------------------------------
    # Install Docker CE (RHEL/CentOS)
    # --------------------------------------------------
    - name: Install Docker prerequisites
      dnf:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present

    - name: Add Docker CE repository
      get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker CE and Compose plugin
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Enable and start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    # --------------------------------------------------
    # Copy TLS certificate and key
    # --------------------------------------------------
    - name: Copy TLS certificate and key
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode }}"
      loop:
        - { src: "{{ tls_cert_src }}", dest: "{{ tls_cert_dest }}", mode: '0644' }
        - { src: "{{ tls_key_src }}", dest: "{{ tls_key_dest }}", mode: '0600' }

    # --------------------------------------------------
    # Generate secrets for .env
    # --------------------------------------------------
    - name: Generate Postgres password
      shell: "openssl rand -base64 {{ pg_pass_length }} | tr -d '\\n'"
      register: pg_pass
      no_log: true

    - name: Generate Authentik secret key
      shell: "openssl rand -base64 {{ secret_key_length }} | tr -d '\\n'"
      register: secret_key
      no_log: true

    - name: Write .env file with HTTPS configuration
      copy:
        dest: "{{ env_file }}"
        content: |
          PG_PASS={{ pg_pass.stdout }}
          AUTHENTIK_SECRET_KEY={{ secret_key.stdout }}
          AUTHENTIK_HTTPS=True
          AUTHENTIK_HTTPS_CERT=/certs/fullchain.pem
          AUTHENTIK_HTTPS_KEY=/certs/privkey.pem
        mode: '0600'

    # --------------------------------------------------
    # Download and modify docker-compose.yml
    # --------------------------------------------------
    - name: Download docker-compose.yml
      get_url:
        url: "{{ docker_compose_url }}"
        dest: "{{ authentik_root }}/docker-compose.yml"
        mode: '0644'

    - name: Add certs volume mount to authentik server service
      replace:
        path: "{{ authentik_root }}/docker-compose.yml"
        regexp: '(\s+server:\s+\n\s+image:.*\n)(\s+)(?!.*volumes:)'
        replace: '\1\2  volumes:\n\2    - ./certs:/certs:ro\n'
      register: compose_modified

    # --------------------------------------------------
    # Pull and start Authentik stack
    # --------------------------------------------------
    - name: Pull Authentik Docker images
      shell: docker-compose pull
      args:
        chdir: "{{ authentik_root }}"

    - name: Start Authentik containers
      shell: docker-compose up -d
      args:
        chdir: "{{ authentik_root }}"

    # --------------------------------------------------
    # Wait for containers to be healthy
    # --------------------------------------------------
    - name: Wait for server container
      shell: docker-compose ps --services --filter "status=running" server
      args:
        chdir: "{{ authentik_root }}"
      register: server_status
      retries: 30
      delay: 10
      until: server_status.stdout != ""
      changed_when: false

    - name: Wait for worker container
      shell: docker-compose ps --services --filter "status=running" worker
      args:
        chdir: "{{ authentik_root }}"
      register: worker_status
      retries: 30
      delay: 10
      until: worker_status.stdout != ""
      changed_when: false

    # --------------------------------------------------
    # Display completion information
    # --------------------------------------------------
    - name: Show Authentik access information
      debug:
        msg:
          - "=== Authentik Installation Complete ==="
          - "HTTPS URL: https://{{ authentik_host }}:{{ authentik_port }}/if/flow/initial-setup/"
          - "Admin user: {{ authentik_admin_user }}"
          - "Set password via web interface above"
          - "PostgreSQL password: {{ pg_pass.stdout }}"
          - "Secret key stored in: {{ env_file }}"
      no_log: false