---
- name: Verify and install oc-mirror
  hosts: 127.0.0.1
  connection: local
  become: true

  vars:
    # -------------------
    # Versions & URLs
    # -------------------
    ocp_release: "4.18.30"
    oc_mirror_url: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/{{ ocp_release }}/oc-mirror.tar.gz"

    # -------------------
    # Installation paths
    # -------------------
    install_dir: /usr/local/bin
    work_dir: /opt/oc-mirror
    oc_mirror_bin: "{{ install_dir }}/oc-mirror"

  tasks:
  # --------------------------------------------------
  # Ensure required packages
  # --------------------------------------------------
  - name: Ensure required packages are installed
    dnf:
      name:
        - curl
        - tar
      state: present

  - name: Create working directory
    file:
      path: "{{ work_dir }}"
      state: directory
      mode: '0755'

  # --------------------------------------------------
  # Check if oc-mirror is installed
  # --------------------------------------------------
  - name: Check if oc-mirror exists
    command: "{{ oc_mirror_bin }} --help"
    register: oc_mirror_check
    failed_when: false
    changed_when: false

  - name: Determine if oc-mirror install is required
    set_fact:
      oc_mirror_install_needed: "{{ oc_mirror_check.rc != 0 }}"

  - name: Debug install decision
    debug:
      msg:
        - "oc-mirror present: {{ oc_mirror_check.rc == 0 }}"
        - "Install needed: {{ oc_mirror_install_needed }}"

  # --------------------------------------------------
  # Install oc-mirror (idempotent)
  # --------------------------------------------------
  - name: Download oc-mirror archive
    get_url:
      url: "{{ oc_mirror_url }}"
      dest: "{{ work_dir }}/oc-mirror.tar.gz"
      mode: '0644'
    when: oc_mirror_install_needed

  - name: Extract oc-mirror archive
    unarchive:
      src: "{{ work_dir }}/oc-mirror.tar.gz"
      dest: "{{ work_dir }}"
      remote_src: yes
    when: oc_mirror_install_needed

  - name: Install oc-mirror binary
    copy:
      src: "{{ work_dir }}/oc-mirror"
      dest: "{{ oc_mirror_bin }}"
      mode: '0755'
      remote_src: yes
    when: oc_mirror_install_needed

  # --------------------------------------------------
  # Cleanup (ONLY after install)
  # --------------------------------------------------
  - name: Remove oc-mirror tarball
    file:
      path: "{{ work_dir }}/oc-mirror.tar.gz"
      state: absent
    when: oc_mirror_install_needed

  - name: Remove extracted oc-mirror binary from workdir
    file:
      path: "{{ work_dir }}/oc-mirror"
      state: absent
    when: oc_mirror_install_needed

  # --------------------------------------------------
  # Verification (supported flags)
  # --------------------------------------------------
  - name: Verify oc-mirror installation (v2)
    command: "{{ oc_mirror_bin }} --v2 version"
    register: oc_mirror_final
    changed_when: false

  - name: Show oc-mirror version
    debug:
      var: oc_mirror_final.stdout_lines
