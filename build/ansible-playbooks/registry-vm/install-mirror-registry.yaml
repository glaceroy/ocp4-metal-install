---
- hosts: 127.0.0.1
  connection: local
  become: true
  
  vars:
    oc_mirror_version: "1.3.11"   # desired version
    download_dir: "/root"
    mirror_binary_path: "{{ download_dir }}/mirror-registry"

  tasks:
    - name: Ensure required packages are installed
      yum:
        name:
          - wget
          - tar
        state: present

    - name: Check if oc-mirror is already installed
      command: "{{ mirror_binary_path }} --version"
      register: mirror_installed
      ignore_errors: true
      changed_when: false

    - name: Extract installed version
      set_fact:
        installed_version: "{{ mirror_installed.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+') | default('0.0.0') }}"

    - name: Set install_needed flag
      set_fact:
        install_needed: "{{ mirror_installed.rc != 0 or (installed_version is version(oc_mirror_version, '<')) }}"

    - name: Download OpenShift oc-mirror binary
      ansible.builtin.get_url:
        url: "https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/{{ oc_mirror_version }}/mirror-registry.tar.gz"
        dest: "{{ download_dir }}/mirror-registry.tar.gz"
        mode: '0644'
      when: install_needed

    - name: Extract oc-mirror tarball
      ansible.builtin.unarchive:
        src: "{{ download_dir }}/mirror-registry.tar.gz"
        dest: "{{ download_dir }}/"
        remote_src: yes
        mode: '0755'
      when: install_needed

    - name: Verify oc-mirror installation
      command: "{{ mirror_binary_path }} --version"
      register: mirror_version
      changed_when: false

    - name: Show oc-mirror version
      debug:
        var: mirror_version.stdout_lines

    - name: Set registry hostname
      command: "hostname -f"
      register: hostname_result

    - name: Install mirror registry
      command: "{{ download_dir }}/mirror-registry install --quayHostname {{ hostname_result.stdout }}"
      register: mirror_install
      ignore_errors: false

    - name: Show mirror install output
      debug: 
        var: mirror_install.stdout_lines