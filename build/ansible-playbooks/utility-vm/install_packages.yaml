---
- hosts: 127.0.0.1
  connection: local
  
  vars:
    files_source_path: ~/ocp4-metal-install/build/
    install_path: /usr/local/bin
    oc_version: "4.20.8"

  tasks:
    - name: Install required packages
      dnf:
        name:
          - git
          - wget
          - vim
          - bind
          - bind-utils
          - bash-completion
          - httpd
          - dhcp-server
          - haproxy
          - nfs-utils
        state: latest

    ###############################
    # KUBECTL INSTALL / UPDATE
    ###############################
    - name: Check current kubectl version
      command: kubectl version --client
      register: current_kubectl
      ignore_errors: yes
      changed_when: false

    - name: Parse installed kubectl version
      set_fact:
        installed_version: "{{ (current_kubectl.stdout | regex_search('Client Version: v([0-9.]+)', '\\1') | first) | default('0.0.0') }}"

    - name: Get latest stable kubectl version
      ansible.builtin.uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: yes
      register: latest_version

    - name: Normalize latest kubectl version
      set_fact:
        latest_kubectl_version: "{{ latest_version.content | trim }}"

    - name: Kubectl version info
      debug:
        msg:
          installed: "{{ installed_version }}"
          latest: "{{ latest_kubectl_version }}"

    - name: Download latest kubectl if needed
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/{{ latest_kubectl_version }}/bin/linux/amd64/kubectl"
        dest: "{{ install_path }}/kubectl"
        mode: '0755'
      when: current_kubectl.failed or ('v' ~ installed_version) is version(latest_kubectl_version, '<')

    ###############################
    # OC CLIENT INSTALL / UPDATE
    ###############################
    - name: Check current oc version
      command: oc version --client
      register: current_oc
      ignore_errors: yes
      changed_when: false

    - name: Parse installed oc version
      set_fact:
        installed_oc_version: "{{ (current_oc.stdout | regex_search('Client Version: v?([0-9.]+)', '\\1') | first) | default('0.0.0') }}"

    - name: Show OC versions
      debug:
        msg:
          installed: "{{ installed_oc_version }}"
          requested: "{{ oc_version }}"

    - name: Check if oc binary exists
      ansible.builtin.stat:
        path: "{{ install_path }}/oc"
      register: oc_stat

    - name: Download and extract oc client if needed
      ansible.builtin.unarchive:
        src: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/{{ oc_version }}/openshift-client-linux.tar.gz"
        dest: "{{ install_path }}"
        mode: '0755'
        remote_src: yes
        exclude: '*.md'
      when: not oc_stat.stat.exists or installed_oc_version is version(oc_version, '<')

    ###############################
    # BASH COMPLETION
    ###############################
    - name: Enable bash completion for oc
      ansible.builtin.lineinfile:
        path: /etc/bashrc
        line: 'source <(oc completion bash)'
        state: present

    - name: Enable bash completion for kubectl
      ansible.builtin.lineinfile:
        path: /etc/bashrc
        line: 'source <(kubectl completion bash)'
        state: present

    ###############################
    # DNS, DHCP, HAProxy, NFS
    ###############################
    - name: Copy bind DNS configuration file
      ansible.builtin.copy:
        src: "{{ files_source_path }}/dns/named.conf"
        dest: /etc/named.conf
        owner: root
        group: root
        mode: '0644'

    - name: Ensure named zones directory exists
      ansible.builtin.file:
        path: /etc/named/zones
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Copy zone files for ocp.cloud.lab
      ansible.builtin.copy:
        src: "{{ files_source_path }}/dns/zones/{{ item }}"
        dest: /etc/named/zones/{{ item }}
        owner: root
        group: root
        mode: '0644'
        force: yes
      loop:
        - db.cloud.lab
        - db.reverse
      loop_control:
        label: "{{ item }}"

    - name: Copy dhcpd configuration file
      ansible.builtin.copy:
        src: "{{ files_source_path }}/dhcpd/dhcpd.conf"
        dest: /etc/dhcp/dhcpd.conf
        owner: root
        group: root
        mode: '0644'

    - name: Copy haproxy mgmt ingress configuration file
      ansible.builtin.copy:
        src: "{{ files_source_path }}/haproxy-mgmt-ingress/haproxy.cfg"
        dest: /etc/haproxy/haproxy.cfg
        owner: root
        group: root
        mode: '0644'

    - name: Allow HAProxy to connect to any port (SELinux)
      ansible.posix.seboolean:
        name: haproxy_connect_any
        state: true
        persistent: yes

    - name: Update Apache listen port
      ansible.builtin.replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^Listen\s+80$'
        replace: 'Listen 0.0.0.0:8080'

    - name: Configure NFS shares
      ansible.builtin.file:
        path: /shares/registry
        state: directory
        owner: nobody
        group: nobody
        mode: '0777'

    - name: Store server IP in a variable
      ansible.builtin.set_fact:
        server_ip: "{{ ansible_default_ipv4.address }}"

    - name: Configure NFS export for registry
      ansible.builtin.lineinfile:
        path: /etc/exports
        regexp: "^/shares/registry"
        line: "/shares/registry {{ server_ip }}/24(rw,sync,root_squash,no_subtree_check,no_wdelay)"
        create: yes

    - name: Reload NFS exports
      ansible.builtin.command: exportfs -rv

    ###############################
    # Validate DNS configuration
    ###############################
    - name: Validate forward zone
      command: named-checkzone cloud.lab /etc/named/zones/db.cloud.lab
      changed_when: false

    - name: Validate reverse zone
      command: named-checkzone 0.10.10.in-addr.arpa /etc/named/zones/db.reverse
      changed_when: false