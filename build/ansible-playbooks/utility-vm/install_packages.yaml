---
- hosts: 127.0.0.1
  connection: local
  become: yes

  vars:
    files_source_path: ~/ocp4-metal-install/build/
    install_path: /usr/local/bin
    oc_version: "4.18.30"
    binaries:
      - name: oc
        # oc version output usually contains "Client Version: 4.20.8" or similar
        version_regex: '([0-9]+\.[0-9]+\.[0-9]+)'
        url_template: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/{{ oc_version }}/openshift-client-linux.tar.gz"
      - name: openshift-install
        # openshift-install version output usually contains "openshift-install 4.20.8"
        version_regex: '([0-9]+\.[0-9]+\.[0-9]+)'
        url_template: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/{{ oc_version }}/openshift-install-linux.tar.gz"
    completion_binaries:
      - oc
      - openshift-install

  tasks:
    ###############################
    # INSTALL REQUIRED PACKAGES
    ###############################
    - name: Install required packages
      dnf:
        name:
          - git
          - wget
          - vim
          - bind
          - bind-utils
          - bash-completion
          - httpd
          - dhcp-server
          - haproxy
          - nfs-utils
          - helm
        state: latest

    ###############################
    # INSTALL/UPDATE OC AND OPENSHIFT-INSTALL
    ###############################
    - name: Check if binaries exist
      stat:
        path: "{{ install_path }}/{{ item.name }}"
      register: binary_stat
      loop: "{{ binaries }}"
      loop_control:
        loop_var: item
        index_var: idx

    - name: Get installed version (if exists)
      command: "{{ install_path }}/{{ item.name }} version"
      register: current_version
      failed_when: false
      changed_when: false
      when: binary_stat.results[idx].stat.exists
      loop: "{{ binaries }}"
      loop_control:
        loop_var: item
        index_var: idx

    - name: Set installed version facts
      set_fact:
        "installed_{{ item.name | replace('-', '_') }}_version": >-
          {{
            (
              current_version.results[idx].stdout
              | default('')
              | regex_search(item.version_regex)
            )
            | default('0.0.0')
          }}
      loop: "{{ binaries }}"
      loop_control:
        loop_var: item
        index_var: idx

    - name: Show installed and requested versions
      debug:
        msg:
          installed: "{{ lookup('vars', 'installed_' + (item.name | replace('-', '_')) + '_version') | default('0.0.0') }}"
          requested: "{{ oc_version }}"
      loop: "{{ binaries }}"
      loop_control:
        loop_var: item

    - name: Download and extract binary if needed
      unarchive:
        src: "{{ item.url_template }}"
        dest: "{{ install_path }}"
        mode: '0755'
        remote_src: yes
        exclude: '*.md'
      loop: "{{ binaries }}"
      loop_control:
        loop_var: item
        index_var: idx
      when:
        - not binary_stat.results[idx].stat.exists
          or (
              (lookup('vars', 'installed_' + (item.name | replace('-', '_')) + '_version')
               | default('0.0.0'))
              is version(oc_version, '<')
            )

    ###############################
    # BASH COMPLETION
    ###############################
    - name: Enable bash completion for binaries
      lineinfile:
        path: /etc/bashrc
        line: "source <({{ item }} completion bash)"
        state: present
      loop: "{{ completion_binaries }}"

    ###############################
    # DNS, DHCP, HAProxy, NFS
    ###############################
    - name: Copy bind DNS configuration file
      copy:
        src: "{{ files_source_path }}/dns/named.conf"
        dest: /etc/named.conf
        owner: root
        group: root
        mode: '0644'

    - name: Ensure named zones directory exists
      file:
        path: /etc/named/zones
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Copy zone files for ocp.cloud.lab
      copy:
        src: "{{ files_source_path }}/dns/zones/{{ item }}"
        dest: "/etc/named/zones/{{ item }}"
        owner: root
        group: root
        mode: '0644'
        force: yes
      loop:
        - db.cloud.lab
        - db.0.10.10
        - db.0.168.192
      loop_control:
        label: "{{ item }}"

    - name: Copy dhcpd configuration file
      copy:
        src: "{{ files_source_path }}/dhcpd/dhcpd.conf"
        dest: /etc/dhcp/dhcpd.conf"
        owner: root
        group: root
        mode: '0644'

    - name: Copy haproxy mgmt ingress configuration file
      copy:
        src: "{{ files_source_path }}/haproxy-mgmt-ingress/haproxy.cfg"
        dest: /etc/haproxy/haproxy.cfg"
        owner: root
        group: root
        mode: '0644'

    - name: Allow HAProxy to connect to any port (SELinux)
      ansible.posix.seboolean:
        name: haproxy_connect_any
        state: true
        persistent: yes

    - name: Update Apache listen port
      replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^Listen\s+80$'
        replace: 'Listen 0.0.0.0:8080'
      notify: restart httpd

    - name: Configure NFS shares
      file:
        path: /shares/openshift
        state: directory
        owner: nobody
        group: nobody
        mode: '0777'

    - name: Store server IP in a variable
      set_fact:
        server_ip: "{{ ansible_default_ipv4.address }}"

    - name: Configure NFS export for openshift
      lineinfile:
        path: /etc/exports
        regexp: "^/shares/openshift"
        line: "/shares/openshift {{ server_ip }}/24(rw,sync,root_squash,no_subtree_check,no_wdelay)"
        create: yes
        mode: '0644'

    - name: Reload NFS exports
      command: exportfs -rv
      become: yes

    ###############################
    # Validate DNS configuration
    ###############################
    - name: Validate forward zone
      command: named-checkzone cloud.lab /etc/named/zones/db.cloud.lab
      changed_when: false

    - name: Validate reverse zone - 10.10.0
      command: named-checkzone 0.10.10.in-addr.arpa /etc/named/zones/db.0.10.10
      changed_when: false

    - name: Validate reverse zone - 192.168.0
      command: named-checkzone 0.168.192.in-addr.arpa /etc/named/zones/db.0.168.192
      changed_when: false
