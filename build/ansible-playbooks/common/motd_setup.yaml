---
- name: Configure MOTD on lab VMs
  hosts: lab_vms
  become: true
  gather_facts: true

  vars:
    base_motd: |
      ***************************************************
      *   Welcome To {{ vm_name }} Server               *
      *   Managed By Ansible                            *
      *   Unauthorized Access Is Prohibited.            *
      *   With Great Power Comes Great Responsibility.  *
      ***************************************************

  tasks:
    - name: Set vm_name per host
      ansible.builtin.set_fact:
        vm_name: "{{ inventory_hostname }}"

    - name: Deploy MOTD with VM-specific name
      ansible.builtin.copy:
        dest: /etc/motd
        content: "{{ base_motd }}"
        owner: root
        group: root
        mode: "0644"

    - name: Ensure SSH prints MOTD
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PrintMotd'
        line: 'PrintMotd yes'
        state: present
        backup: true

    - name: Restart SSH service on RHEL-like systems
      ansible.builtin.service:
        name: sshd
        state: restarted
      when: ansible_facts.os_family in ['RedHat', 'Rocky', 'AlmaLinux', 'CentOS']

    - name: Restart SSH service on Debian-based systems
      ansible.builtin.service:
        name: ssh
        state: restarted
      when: ansible_facts.os_family == 'Debian'
